name: 🚀 Deploy to Strato via SCP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Code aus GitHub laden
        uses: actions/checkout@v3

      - name: 🔧 Node.js einrichten
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Abhängigkeiten installieren
        run: npm install

      - name: 🏗 Angular Projekt bauen + Sitemap erzeugen
        run: |
          npm run build -- --configuration production
          node generate-sitemap.js

      - name: 📥 LFTP installieren
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: 🚀 Dateien per SFTP mit lftp hochladen (inkl. Bereinigung)
        run: |
          echo "set ssl:verify-certificate no" > lftp.conf
          echo "set sftp:auto-confirm yes" >> lftp.conf
          echo "open -u ${{ secrets.SFTP_USERNAME }},${{ secrets.SFTP_PASSWORD }} sftp://${{ secrets.SFTP_SERVER }}:${{ secrets.SFTP_PORT }}" >> lftp.conf
          echo "mirror -R --delete dist/porftolio_frontend/browser/ /adrianensslin/" >> lftp.conf
          lftp -f lftp.conf
